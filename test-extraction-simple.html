<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Content Extraction Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-content {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .debug-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
    </style>
</head>
<body>
    <h1>Simple Content Extraction Test</h1>
    
    <div class="debug-info">
        <strong>Debug Information:</strong><br>
        <span id="debug-info">Loading...</span>
    </div>

    <div class="test-content">
        <h2>Sample Article: The Future of Renewable Energy</h2>
        <p>Renewable energy sources are becoming increasingly important in our fight against climate change. Solar panels and wind turbines are now more efficient and cost-effective than ever before.</p>
        <p>Countries around the world are investing heavily in clean energy infrastructure. This transition not only helps reduce carbon emissions but also creates new job opportunities in the green technology sector.</p>
        <p>The next decade will be crucial for determining whether we can successfully transition to a sustainable energy future. Innovation in battery technology and smart grid systems will play a key role in this transformation.</p>
        <p>Many experts believe that renewable energy will become the dominant source of power within the next 20 years. This shift represents one of the most significant changes in how we generate and consume energy since the industrial revolution.</p>
    </div>

    <div>
        <button onclick="testContentExtraction()">Test Content Extraction</button>
        <button onclick="testStorageAccess()">Test Storage Access</button>
        <button onclick="testExtensionContext()">Test Extension Context</button>
        <button onclick="clearStorage()">Clear Storage</button>
    </div>

    <div id="results" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap; font-family: monospace;"></div>

    <script>
        const debugInfo = document.getElementById('debug-info');
        const results = document.getElementById('results');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `${timestamp}: ${message}\n`;
            console.log(`[Test] ${message}`);
        }
        
        function updateDebugInfo() {
            const info = [
                `URL: ${window.location.href}`,
                `Title: ${document.title}`,
                `Body text length: ${document.body.innerText?.length || 0}`,
                `Extension context: ${window.chrome ? 'Available' : 'Not available'}`,
                `Storage: ${window.chrome?.storage ? 'Available' : 'Not available'}`
            ];
            debugInfo.innerHTML = info.join('<br>');
        }
        
        function testContentExtraction() {
            log('Testing content extraction...');
            
            try {
                // Test basic content extraction
                const bodyText = document.body.innerText || document.body.textContent || '';
                const wordCount = bodyText.split(/\s+/).filter(w => w.length > 0).length;
                
                log(`✓ Basic extraction successful`);
                log(`  - Content length: ${bodyText.length} characters`);
                log(`  - Word count: ${wordCount} words`);
                
                // Test article content specifically
                const article = document.querySelector('.test-content');
                if (article) {
                    const articleText = article.innerText || article.textContent || '';
                    const articleWords = articleText.split(/\s+/).filter(w => w.length > 0).length;
                    
                    log(`✓ Article extraction successful`);
                    log(`  - Article length: ${articleText.length} characters`);
                    log(`  - Article words: ${articleWords} words`);
                    
                    // Test if content meets minimum requirements
                    if (articleWords >= 50) {
                        log(`✓ Content meets minimum word requirement (${articleWords} >= 50)`);
                    } else {
                        log(`✗ Content too short (${articleWords} < 50 words)`);
                    }
                } else {
                    log('✗ Could not find article content');
                }
                
            } catch (error) {
                log(`✗ Content extraction failed: ${error.message}`);
            }
        }
        
        function testStorageAccess() {
            log('Testing storage access...');
            
            const testData = {
                lessonConfiguration: {
                    sourceContent: 'Test content for lesson generation',
                    suggestedType: 'discussion',
                    suggestedLevel: 'B1',
                    metadata: {
                        title: document.title,
                        sourceUrl: window.location.href,
                        domain: window.location.hostname,
                        extractedAt: new Date(),
                        wordCount: 6,
                        readingTime: 1,
                        complexity: 'intermediate',
                        suitabilityScore: 0.8
                    },
                    extractionSource: 'webpage',
                    allowContentEditing: true,
                    userCanModifySettings: true,
                    attribution: 'Test attribution'
                }
            };
            
            // Test Chrome storage if available
            if (window.chrome?.storage) {
                try {
                    chrome.storage.local.set(testData, () => {
                        if (chrome.runtime.lastError) {
                            log(`✗ Chrome storage failed: ${chrome.runtime.lastError.message}`);
                            testLocalStorageFallback(testData);
                        } else {
                            log('✓ Chrome storage successful');
                            
                            // Test retrieval
                            chrome.storage.local.get(['lessonConfiguration'], (result) => {
                                if (chrome.runtime.lastError) {
                                    log(`✗ Chrome storage retrieval failed: ${chrome.runtime.lastError.message}`);
                                } else if (result.lessonConfiguration) {
                                    log('✓ Chrome storage retrieval successful');
                                    log(`  - Retrieved content length: ${result.lessonConfiguration.sourceContent.length}`);
                                } else {
                                    log('✗ No data retrieved from Chrome storage');
                                }
                            });
                        }
                    });
                } catch (error) {
                    log(`✗ Chrome storage access failed: ${error.message}`);
                    testLocalStorageFallback(testData);
                }
            } else {
                log('Chrome storage not available, testing localStorage fallback');
                testLocalStorageFallback(testData);
            }
        }
        
        function testLocalStorageFallback(testData) {
            try {
                localStorage.setItem('linguaspark_lesson_config', JSON.stringify(testData));
                log('✓ localStorage fallback successful');
                
                const retrieved = localStorage.getItem('linguaspark_lesson_config');
                if (retrieved) {
                    const parsed = JSON.parse(retrieved);
                    log('✓ localStorage retrieval successful');
                    log(`  - Retrieved content length: ${parsed.lessonConfiguration.sourceContent.length}`);
                } else {
                    log('✗ No data retrieved from localStorage');
                }
            } catch (error) {
                log(`✗ localStorage fallback failed: ${error.message}`);
            }
        }
        
        function testExtensionContext() {
            log('Testing extension context...');
            
            try {
                const hasChrome = !!window.chrome;
                const hasRuntime = !!(window.chrome?.runtime);
                const hasRuntimeId = !!(window.chrome?.runtime?.id);
                const hasStorage = !!(window.chrome?.storage);
                
                log(`Chrome object: ${hasChrome ? 'Available' : 'Not available'}`);
                log(`Runtime: ${hasRuntime ? 'Available' : 'Not available'}`);
                log(`Runtime ID: ${hasRuntimeId ? 'Available' : 'Not available'}`);
                log(`Storage: ${hasStorage ? 'Available' : 'Not available'}`);
                
                if (hasChrome && hasRuntime && hasRuntimeId) {
                    log('✓ Extension context appears valid');
                } else {
                    log('✗ Extension context invalid or not available');
                    log('  This is expected when testing in a regular web page');
                }
                
            } catch (error) {
                log(`✗ Extension context test failed: ${error.message}`);
            }
        }
        
        function clearStorage() {
            log('Clearing all storage...');
            
            try {
                // Clear Chrome storage if available
                if (window.chrome?.storage) {
                    chrome.storage.local.clear(() => {
                        if (chrome.runtime.lastError) {
                            log(`Chrome storage clear error: ${chrome.runtime.lastError.message}`);
                        } else {
                            log('✓ Chrome storage cleared');
                        }
                    });
                }
                
                // Clear localStorage
                localStorage.removeItem('linguaspark_lesson_config');
                log('✓ localStorage cleared');
                
                // Clear sessionStorage
                sessionStorage.removeItem('linguaspark_lesson_config');
                log('✓ sessionStorage cleared');
                
            } catch (error) {
                log(`✗ Storage clearing failed: ${error.message}`);
            }
        }
        
        // Initialize
        updateDebugInfo();
        log('Simple content extraction test initialized');
        log('Click the buttons above to test different aspects of the extraction system');
        
        // Auto-run basic tests
        setTimeout(() => {
            testContentExtraction();
            testExtensionContext();
        }, 1000);
    </script>
</body>
</html>