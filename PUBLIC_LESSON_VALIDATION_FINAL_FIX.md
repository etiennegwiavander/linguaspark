# Public Lesson Validation Final Fix

## Problem Identified
The debug output revealed that the lesson structure being sent to public lesson validation was:

```json
{
  "warmup": {
    "questions": ["instruction", "question1", "question2", "question3"]
  },
  "wrapup": {
    "questions": ["instruction", "question1", "question2", "question3"]
  }
}
```

But the validation was expecting:
- Warmup: `{ questions: [...] }` ✅ (this was working)
- Wrapup: `{ summary: "text" }` ❌ (this was failing)

## Root Cause
The wrapup validation was looking for a `summary` property, but the actual lesson structure has a `questions` property just like warmup. This mismatch caused the validation to fail.

## Solution Applied
Updated the wrapup validation to handle the actual structure being sent:

### Before (Incorrect)
```typescript
// Only accepted object with summary
else if (typeof content.wrapup === 'object' && 'summary' in content.wrapup) {
  if (!content.wrapup.summary || content.wrapup.summary.trim().length === 0) {
    errors.push('Wrapup section summary cannot be empty');
  }
}
```

### After (Correct)
```typescript
// Accepts object with questions array (current format) OR summary (legacy)
else if (typeof content.wrapup === 'object' && content.wrapup !== null) {
  // Object with questions array (current format from lesson generator)
  if ('questions' in content.wrapup && Array.isArray(content.wrapup.questions)) {
    if (content.wrapup.questions.length === 0) {
      errors.push('Wrapup section must contain at least one question or instruction');
    }
  }
  // Legacy object format with summary
  else if ('summary' in content.wrapup) {
    if (!content.wrapup.summary || content.wrapup.summary.trim().length === 0) {
      errors.push('Wrapup section summary cannot be empty');
    }
  }
  // Invalid object format
  else {
    errors.push('Wrapup section object must contain either questions array or summary');
  }
}
```

## Lesson Structure Formats Supported

### 1. Current Format (from lesson generator)
```json
{
  "warmup": { "questions": ["instruction", "q1", "q2", "q3"] },
  "wrapup": { "questions": ["instruction", "q1", "q2", "q3"] }
}
```

### 2. Direct Array Format (from progressive generator)
```json
{
  "warmup": ["instruction", "q1", "q2", "q3"],
  "wrapup": ["instruction", "q1", "q2", "q3"]
}
```

### 3. Legacy Format (backward compatibility)
```json
{
  "warmup": { "questions": ["q1", "q2", "q3"] },
  "wrapup": { "summary": "lesson summary text" }
}
```

## Key Changes Made

1. **Wrapup Validation Enhancement**: Now accepts objects with `questions` array (current format)
2. **Maintained Backward Compatibility**: Still supports legacy `summary` format
3. **Consistent Structure**: Both warmup and wrapup now support the same object format
4. **Better Error Messages**: More specific validation feedback

## Files Modified
- `lib/public-lessons-server.ts` - Updated `validatePublicLessonContent()` function

## Expected Result
✅ Public lesson saving should now work successfully
✅ Lessons generated by the current system can be saved to public library
✅ Legacy lesson formats continue to work
✅ Clear validation errors for invalid formats

This fix addresses the structure mismatch between what the lesson generator produces and what the public lesson validation expects.