# Public Lesson Validation Format Fix

## Problem
Public lesson saving was failing with "Lesson content validation failed" error, specifically:
- "Wrapup section with summary is required"
- The validation was expecting legacy lesson format but receiving new progressive generator format

## Root Cause
The public lesson validation function was expecting the old lesson structure:
```typescript
// Expected (legacy format)
{
  warmup: { questions: string[] },
  wrapup: { summary: string }
}

// Actual (new progressive generator format)
{
  warmup: string[],  // Array with instruction + questions
  wrapup: string[]   // Array with instruction + questions
}
```

## Solution
Updated the validation function in `lib/public-lessons-server.ts` to handle both formats:

### 1. Warmup Section Validation
```typescript
// Before: Only accepted object with questions array
if (!content.warmup || !content.warmup.questions || content.warmup.questions.length === 0) {
  errors.push('Warmup section with at least one question is required');
}

// After: Accepts both array and object formats
if (!content.warmup) {
  errors.push('Warmup section is required');
} else {
  // New array format (progressive generator)
  if (Array.isArray(content.warmup)) {
    if (content.warmup.length === 0) {
      errors.push('Warmup section must contain at least one question or instruction');
    }
  }
  // Legacy object format
  else if (typeof content.warmup === 'object' && content.warmup.questions) {
    if (!Array.isArray(content.warmup.questions) || content.warmup.questions.length === 0) {
      errors.push('Warmup section must contain at least one question');
    }
  }
  // Invalid format
  else {
    errors.push('Warmup section must be either an array of questions or an object with questions array');
  }
}
```

### 2. Wrapup Section Validation
```typescript
// Before: Only accepted object with summary
if (!content.wrapup || !content.wrapup.summary || content.wrapup.summary.trim().length === 0) {
  errors.push('Wrapup section with summary is required');
}

// After: Accepts both array and object formats
if (!content.wrapup) {
  errors.push('Wrapup section is required');
} else {
  // New array format (progressive generator)
  if (Array.isArray(content.wrapup)) {
    if (content.wrapup.length === 0) {
      errors.push('Wrapup section must contain at least one question or instruction');
    }
  } 
  // Legacy object format
  else if (typeof content.wrapup === 'object' && content.wrapup.summary) {
    if (content.wrapup.summary.trim().length === 0) {
      errors.push('Wrapup section summary cannot be empty');
    }
  }
  // Invalid format
  else {
    errors.push('Wrapup section must be either an array of questions or an object with summary');
  }
}
```

## Progressive Generator Format
The new progressive generator creates sections as arrays:
- **Warmup**: `["Have the following conversations...", "Question 1?", "Question 2?", "Question 3?"]`
- **Wrapup**: `["Reflect on your learning...", "Question 1?", "Question 2?", "Question 3?"]`

This format includes:
1. First element: Instruction text for the tutor
2. Remaining elements: Actual questions for discussion

## Benefits
1. **Backward Compatibility**: Still accepts legacy lesson formats
2. **Forward Compatibility**: Supports new progressive generator format
3. **Flexible Validation**: Validates content regardless of structure
4. **Better Error Messages**: More specific validation feedback

## Testing
- ✅ New progressive generator lessons can be saved to public library
- ✅ Legacy lesson formats still work
- ✅ Proper validation errors for invalid formats
- ✅ Private lesson saving continues to work (unaffected)

## Files Modified
- `lib/public-lessons-server.ts` - Updated `validatePublicLessonContent()` function

This fix ensures that lessons generated by the new progressive generator can be successfully saved to the public library while maintaining compatibility with existing lesson formats.